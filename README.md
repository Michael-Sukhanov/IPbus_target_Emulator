# :computer: IPbus target Emulator v3 

## Описание 
Программа предназначена для эмулирования электронники, работающей по протоколу IPbus v2. При запуске исполняемого файла утилита открывает порт № __50001__ на своём локальном IP-адресе и ждет пакеты по UDP протколу. В слчае если пакет соответствует структуре IPbus, то программа обрабатывает его, формирует и посылает ответ на тот IP-адрес и порт, с которого пришел запрос. Основной документ, описывающий IPbus протокол доступен по [ссылке](https://ipbus.web.cern.ch/ipbus/).

## Документация
Программа, как уже было написано выше, обрабатывает и отвечает на пакеты, пришедшие по UDP протоколу в формате IPbus. Причем пакеты, не соответствующие данному протоколу игнорируются :no_entry:. Приложение способно принимать и распознавать запросы всех трех типов:

* **Status**
* **Control**
* **ReSend**

### :arrow_left: Status
На любой статус запрос эмулятор отвечает одинаково, используя шаблон, приведенный ниже:
```
F1 00 00 20
F8 07 00 00
10 00 00 00
F0 02 00 20
0F 0F 0F 0F
0F 0F 0F 0F
0F 0F 0F 0F
0E 07 0F 0F
20 00 00 F0
20 00 00 F0
20 00 00 F0
20 00 00 F0
20 00 00 F0
20 00 00 F0
20 00 00 F0
20 00 00 F0
```

### :arrow_right: Control
Приложением могут обрабатываться следующие транзакции в теле Control пакета:

* *write*
* *read*
* *Non-Incrementing write*
* *Non-Incrementing read*
* *RMWsum*
* *RMWbits*

### :arrows_counterclockwise: ReSend
Приложение отчечает на ReSend пакеты солгласно протоколу IPbus без исключений. Эмулятор хранит последние 16 ответных пакетов. В случае переполнения буффера старые пакеты удаляются и заменяются на новые.

## :checkered_flag: Первый запуск

### :link: Привязка к порту
При первом запуске приложения будет произведена попытка привязки к порту __50001__. В случае если этого сделать не удалось в *status bar* будет выведено сообщение `Bind failed`. Это означает, что данный порт уже занят, поэтому требуется его освободить, то есть закрыть ту программу, которая прослушивает его на данный момент. Повторная попытка привязки к порту **кнопкой `Bind`** в случае успеха выведет в *status bar* сообщение `Bind succesfull`.

### Графический интерфейс
![alt](Interface.png)

Графический интерфейс состоит из следующих элементов:

* Меню приложения
* Окно лога
* Окно содержания регистров

Ниже приведено описание функционала для каждого элемента интерфейса:

#### Меню приложения

##### File

Опция `File` содержит в себе две функции: сохранение :inbox_tray: (`Save state`) и загрузка :outbox_tray: (`Load state`) состояний. Состоянием называется значения регистров в эмуляторе в конкретный момент работы. Файлы состояний представляют собой простой текстовый файл с двумя столбцами. Первый столбец содержит адреса регистров с *ненулевыми значениями*. Второй столбец значение регистра в этом состоянии. Регистры с нулевым значением в файл состояния не записываются. При загрузке файла состояния значения регистров записываются в адрессное пространство эмулятора с корректировкой на поставленные ограничения (конфигурации *конфигурации*). Все значения регистров и их адреса записываютя в **шестнадцатиричной** системе.

##### :wrench: Config

Опция `Config` позволяет конфигурировать адресное пространство с помощью так называемых *файлов конфигурации*. **Файлы конфигурации** - вспомогательные файлы, устанавливающие правила записи значений в тот или иной регистр. Структура таких файлов показана ниже. В первом стоблюце указывается адрес, на который накладываются ограничения. Второй столбец указывает, можно ли производить запись в этот регистр (`0`) или он только для чтения (`1`).

###### *Замечание*

*Значения во втором столбце ограничивают запись значений в этот регистр только при применении транзакций, подразумевающих запись по текущему адресу. В случае если значение устанавливается файлом сосояния, то данное ограничение игнорируется.*

Четвертый столбец показывает, является ли значение, записываемое в этот регистр знаковым, или нет, то есть при наличии `1` в этом столбце следует воспринимать величину как число, которое может быть отрицательным. В противном случае число всегда неотрицательное.

Пятый и шестой столбцы показывают левую и правую границы значения, которое может быть записано по этому регистру соответственно. В случае, если включена авто-коррекция значения, попытка записать число не попадающе в интервал приведет к его изменению до ближайшей границы. Если авто-коррекция отключена, то значение будет записана чере битовую маску, которая показывает количество и положение эффективных бит. 

Третий столбец указывает на наличие автокоррекции значения регистра. В случае `1` значения, записанные в этот регистр будут изменены в зависимости от диапазона значений, которые могут находиться по этому адресу. 

Пример файла-конфигурации

```
mask : 11
/* This is configuration file to registers restriction in IPbus-target emulator.
_________________________________Descryption:_____________________________________
#RA - REGISTER ADDRESS: The address of register in address space to restrict.

#RO - READ ONLY: 	Set 1 if this register for read only (Set 0 if not).

#RC - RANGE CORRECTION: Set 1 if you want emulator to correct written value.
			Correction is used if the written value out of range.
			Set 0 if you do not want to correct value.
			In this way value will be filter with effective bits mask.

#S  - SIGNED:		Setting 1 means value is signed (Setting 0 means unsigned)

#LB - LOW BORDER:	Shows the minimal possible value in the range.
			It is used in range correction.
			If range correction off LB is 00000000.

#UP - UPPER BORDER:	Shows the maximal possible value in the range.
			It is used in range correction.
			If range correction off UB shows effective bits mask.
 
#RA		#RO 	     #RC	#S	   #LB		#UB	*/
00000000	0	     1	  	1	   fffffb00	00000500
00000001	0	     1	  	1	   fffffb00	00000500
00000002	0	     1	  	1	   fffffc00	00000400
00000003	0	     0	  	0	   00000000	0000dfff
00000004	0	     0	  	0	   00000000	0000000f
00000005	1	     0	  	1	   00000064	00000258
***
```
Здесь, например, мы можем читать конфигурации так: Значение по адресу 0x1 знаковое, его можно считать и записать. Оно может находиться в диапазоне `[-1024; 1024]`. В случае выхода за пределы диапазона, будет произведена корректировка до ближайшей границы. А, например, значение регистра с адресом 0x5, который в реальной плате отвечает за температуру, знаковое в диапазоне от 100 до 600, можно будет только считать.

В шапке файла имеется маска. Маска нужна для разметки подключенных к TCM модулей. Например в приложенном фрагменте файла `11` означает, что подключены PMA0 и PMA1. В зависимости от того, какое число PM и в какие слоты подключены, конфигурация эмулятора применяется к разным регистрам. Это число может быть в двоичном или шестнадцатиричном виде.

#### Окно логов
Большое окно слева предначзначено для системных сообщений (логов). Формат логов приведен ниже:
```
<19:45:23> Status packet  ( 16 words BE)
<19:45:23> Control packet (  4 words LE)
writing 0x80000000 to 0x0000001B (sequental)
<19:45:31> Status packet  ( 16 words BE)
<19:45:31> Control packet (  3 words LE)
reading   2 words from 0x000002C0 (sequental)
<19:45:31> Status packet  ( 16 words BE)
<19:45:31> Control packet (  3 words LE)
reading   2 words from 0x000002C0 (sequental)
<19:45:31> Status packet  ( 16 words BE)
<19:45:31> Control packet (  3 words LE)
reading   2 words from 0x000002C0 (sequental)
<19:45:32> Status packet  ( 16 words BE)
<19:45:32> Control packet (  3 words LE)
reading   2 words from 0x000002C0 (sequental)
<19:45:42> Status packet  ( 16 words BE)
<19:45:42> Control packet (  4 words LE)
writing 0x00000004 to 0x00000050 (sequental)
<19:45:46> Status packet  ( 16 words BE)
<19:45:46> Control packet (  3 words LE)
reading  16 words from 0x00000000 (sequental)
<19:45:47> Control packet (  3 words LE)
reading   1 words from 0x00000050 (sequental)
```
 
 В треугольных скобках указывается временной штамп со временем, когда пришел пакет. Далее прописывается тип пакета, в скобках его объем в 32-битных словах и порядок байт, в котором пришел пакет. Ниже указывается, что делается с тем или иным регистром. Перечисляется какое значение в какой регистр и в каком режиме записывается. `Sequental` и `non-incrementing` режимы, соответствуют последовательной и FIFO записям. При чтении выводится сообщение, содежащее количество считываемых слов, адресс, откуда они считываются и режим. По умолчанию статус пакеты и транзакции чтения не отображаются, однако в файл они записываются. Увидеть их можно если убрать галочку выше в окне `Write transaction only`.
 
 #### Окно значений
 В окне справа можно увидеть текущее состояние регистра в его адресном пространстве. Для этого достаточно ввести его адрес в поле ввода сверху или выбрать с помощью кнопок :arrow_up: и :arrow_down:, после чего нажать :leftwards_arrow_with_hook:`Enter`. В поле появится значение текщего регистра в формате:
 `
 [0xaddress] = 0x<value>
 `
 Окно для удобства можно очистить, нажав кнопку очистки сверху. Также по введенному адресу регистра в поле ввода можно узнать его ограничения, если они были введены. Для этого необходимо нажать на кнопку с иконкой "i". Информация об ограничения высветится в `status bar`
 
 #### Горячие клавиши
 
 * Получить информацию о конфигурации регистров 	- `Ctrl + I`
 * Очиcтить поле значений регистров			- `Ctrl + E`
 * Выйти из программы 					- `Ctrl + Q`
 * Повторно привязаться к порту 			- `Ctrl + B`
 * Выводить (скрыть) транзакции чтения в окно лога 	- `Ctrl + W`
 * Изменить меню на `toolbar` и наоборот 		- `Ctrl + T`
 
 ## Внутреннее поведение
 
 При загрузке конфигурационного файла, содержащего ограничения на регистры TCM и PM, в эмуляторе происходит инициализация внутреннего обработчика событий. Данное расширение позволяет частично наблюдать измения регистров FEE, как это было бы с реальной аппаратурой. При любом изменении значения регистра пользователем происходит обработка нового значения и дальнейшее поведение электроники меняется в зависимости от адреса регистра и функций, которые он выпоняет. Ниже приведены ситуации, с которыми на данный момент может работать эмулятор. Описания регистров и их функционал реализуется на основании составленных таблиц регистров, с которыми можно ознакомиться по [ссылке](https://onedrive.live.com/view.aspx?resid=7E7CBC355FE4EA69!128&ithint=file%2cxlsx&authkey=!AIHkXzLSmyeY43E). **Все описанные операции не отображаются никоим образом в логах!!**
 
 ### Инициализация конфигурации платы, фоновые процессы
 
 После загрузки конфигурационного файла независимо от регистров, значения которых меняются пользователем, на данный момент в фоновом режиме происходят следующие операции: 
 
 #### Инициализация маски и HDMI link
 
 Маска активных PM, которая прописана в конфигурационном файле принмается за действительную и на ее основе заполняются поля `1A` и `3A`. Подробнее о изменении битовых полей регистров `1A` и `3A` см. в разделе *"Операции, выполняемые при изменении значений регистров: Channel Mask (A|C)"*.
 
#### FPGA/Board temperature `0xFC/0x5` (Температура ПЛИС и модуля)

 Для наглядности работы эмулятора реализовано изменение регистров температуры с шагом 1 как для FPGA, так и для самой платы.
*На данный момент регистры меняются независимо исходя из соображений, что температура меняется по нормальному распределению. Параметры распределения фиксированы исходя из проведенных измерений в лаборатории.

#### Voltage 1/1.8 `0xFD/0xFE` (Измерение напряжений питания)
 Изменение напряжений реализовано похожим образом. Отличие в том, что так как напряжение может меняться скачками, то возможные значения, которые мы можем увидеть будут распределены равномерно в определенных пределах напряжения, которые также фиксированы внутри программы.
 
 ### Операции, выполняемые при изменении значений регистров TCM
 
 #### Laser Control `0x1B`(Управление лазером)
 
 Запись значений в данный регистр позволяет включить/выключить лазер, а также поменять его частоту. Пронаблюдать изменение в электроннике достаточно просто: необходимо проверить регистры соответствующие счетчикам формирователя со следящим порогом (CNT_CFD `0xC0`) для всех указанных в конфигурационном файле PM, которые будут меняться. Для простоты все значения для всех PM и каналов одинаковые (_в будущем, возможно, будет изменено_). 
 
#### Laser Delay `0x2` (Задержка меандра запуска лазера)

Для того, чтобы сработал триггер, необходимо, чтобы столкновение (*в нашем случае лазерная вспышка*) произошло в выбранный для измерений промежуток времени.
Длительность данного промежутка фиксирована и равна 5 нс. С помощью регистра с адресом `0x2` можно изменить положение данного промежутка относительно всего временного окна, длительность которого 25 нс. Таким образом вероятность, что случайное смещение этого промежутка будет содержать момент столкновения - 0.2. На таком достаточно простом уровне, процесс выравнивания фазы демонстрируется в эмуляторе. Путем измения значения регистра с адресом `0x2` нужно добиться того, чтобы  время эмулируемого столкновения попало в промежуток. Этот момент легко отследить путем наблюдения за изменением значений регистров триггерного счетчика (начиная с CNT_TRG `0xC1`) для каждого из подключенных PM.

#### Counters update rate `0x50` (Частота считывания счетчиков)

Все значения счетчиков для каждого отдельного модуле (PM/TCM) помещаются в соответствующие FIFO регистры по адресу `0x.100`, если значение регистра с адресом `0x50` от 0 до 7. При переполнении этих очередей, новые счетчики отбрасываются. Количество значений в FIFO регистре отображается в регистре с адресом `0x.101`.

#### Channel Mask (A|C) `0x1A | 0x3A` (Шаблон подключенных PM для сторон A и C)

Маска - шаблон, который показывает активные процессорные модули, с которых поступает информация. Измение маски позволяет "выключать" и "включать" необходимые PM, если это необходимо. При изменении маски происходит ее проверка, исходя из которой, принимаются следующие решения:

* если PM есть и в конфигурации и в маске, то ему присваивется **_"хороший"_ HDMI link**  `0xD5D25150`.
* ecли PM есть либо в конфигурации, либо в маске, то ему присваивается **_"плохой"_ HDMI link** `0x30B03030`.
* если PM нет ни там, ни там, то его HDMI link принимается равным нулю.
* В случае, если маска для какой либо стороны ненулевая, то для этой стороны в соответствующем бите данного регистра отобразится единица, показывающая, что сторона активна (см. описание регистров).
* Когда HDMI link для каждого PM "хороший", то бит, отвечающий за то, готова ли сторона к измерениям переходит в состояние 1. В случае если это не так, то переходит в ноль.
* Если состояние стороны (ее готовность) изменилась, то бит, сигнализирующий о том, что произошло какое-то изменение, переходит в 1. После чтения данного регистра бит примет значение 0 если до этого он был 1.

#### GBT Control `0xD8` (Управление GBT: выбор режима работы и настройка модуля)

В данном поле реализовно изменение статуса при вводе нового значения в биты SEND READOUT COMMAND. Статус полностью соответствует записанному занчению, причем регистры управления зануляются. Также реализован счетчик банчей и оборотов орбит, то есть CRU BC и CRU ORBIT соответственно. При отправке команды reset orbit sync, эмулятор переводит GBT в режим sync, а счетчики начинают увеличиваться со случайного значения с необходимой частотой в 40 MHz.  

### Операции, выполняемые при изменении значений регистров PM

Следующие изменения регистров работают одинаково для всех отдельных PM, поскольку они независимы:

#### Reset Counters `бит №9 регистра 0xF` (Сброс CFD и TRG счетчиков)

Позволяет занулить счетчики того процессорного модуля для которого посылалась данная команда.

#### GBT Control `0xD8` (Управление GBT: выбор режима работы и настройка модуля)

Работает аналогично модулю TCM.

## Контакты:
По всем вопросам обращаться по email :e-mail: : sukhanov.mikle@yandex.ru
 
 
 
 
